<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vermont CAMA Sample Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <style>
        html, body {
            overflow: hidden; /* Prevent body scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #map-view {
            height: 100%; /* Make map fill its container */
            width: 100%;
        }
        #map-view:focus,
        #map-view:focus-within,
        .esri-view-surface--is-focused {
            outline: none !important;
            box-shadow: none !important;
        }
        div {
            -webkit-tap-highlight-color: transparent;
        }
        div:focus {
            outline: none;
        }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .main-table-row { cursor: pointer; }
        .main-table-row:hover { background-color: #e6f0e6; }
        .related-section h3 {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        #sketch-canvas {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .detail-card {
            background-color: #f9fafb;
            border-left: 4px solid #003300;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
        }
        .esri-popup .esri-popup__main-container {
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex h-screen">
        <div class="w-3/5 h-screen overflow-y-auto relative" id="left-pane">
            <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                <header class="mb-8 text-left">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Vermont CAMA Sample Viewer</h1>
                    <p class="mt-2 text-md text-gray-600"><b>For demo purposes only.</b></p>
                </header>

                <div id="main-view">
                    <div id="filter-status" class="hidden mb-4 p-4 bg-[#e6f0e6] border-l-4 border-[#003300] text-[#003300] rounded-md flex justify-between items-center">
                        <p>Showing data for parcel selected on map.</p>
                        <button id="clear-filter-btn" class="font-bold hover:underline">Clear Map Filter</button>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                            <i class="fa-solid fa-magnifying-glass mr-2" style="color: #003300;"></i>Search by Address or LRSN
                        </label>
                        <input type="text" id="search-input" placeholder="e.g., 'Main St' or '1234'" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#003300] focus:border-[#003300]">
                    </div>

                    <main id="data-container" class="bg-white p-4 rounded-lg shadow-md min-h-[400px] flex flex-col">
                        <div id="status-message" class="flex flex-grow items-center justify-center"></div>
                        <div id="table-wrapper" class="hidden">
                            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                                    <i class="fa-solid fa-sign-hanging mr-3" style="color: #003300;"></i>Properties
                                </h2>
                                <div id="table-info" class="text-sm text-gray-600"></div>
                            </div>
                            <div class="overflow-x-auto table-container">
                                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50"></thead>
                                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                            <div id="pagination-controls" class="mt-4 flex justify-between items-center"></div>
                        </div>
                    </main>
                </div>

                <div id="detail-view" class="hidden">
                    <button id="back-button" class="mb-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#003300] hover:bg-[#002a00] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#003300]">
                        &larr; Back to Search Results
                    </button>
                    <div id="detail-content" class="space-y-8"></div>
                </div>

                <div class="mt-8 text-left text-xs text-gray-500 border-t pt-4">
                    <p>Parcel and CAMA data here are <b>for reference only</b> and are sourced from Vermont municipalities. Neither the State of Vermont nor the contributors of data, services, and products provided here or through the Vermont Open Geodata Portal shall be held liable for any improper or incorrect use of those data, services, and products and assume no responsibility for anyone's use of those data, services, and products. In no event shall the State of Vermont or the contributors be liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement or substitute goods or services; loss of use, data, or profits; or business interruption) however caused and on any theory.</p>
                </div>
            </div>
             <button id="to-top-btn" title="Go to top" class="opacity-0 invisible fixed bottom-8 right-[41%] z-20 bg-[#003300] text-white rounded-full text-2xl w-14 h-14 flex items-center justify-center shadow-lg hover:bg-[#002a00] transition-all duration-300">
                <i class="fa-solid fa-circle-arrow-up"></i>
            </button>
        </div>

        <div class="w-2/5 h-screen">
            <div id="map-view" class="shadow-lg"></div>
        </div>
    </div>
    
<script src="https://js.arcgis.com/4.29/"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const S3_BASE_URL = 'https://s3.us-east-2.amazonaws.com/vtopendata-prd/_Other/CAMA/sample-microsolve/';
        // We will keep the property class codes for now, though they might not match the new schema perfectly yet.
        const PROPERTY_CLASS_CODES_URL = 'https://s3.us-east-2.amazonaws.com/vtopendata-prd/_Other/CAMA/vt_tax_property_class_codes.json';
        
        // EXP_MAIN acts as both the Site_Address and Parcel_Main equivalents
        const MASTER_FILE = 'EXP_MAIN';
        const ESSENTIAL_FILES = ['EXP_MAIN'];
        
        // We will map the new files to the UI categories later. 
        // For now, we load them but won't process them until we define their schemas.
        const RELATED_FILES = {
            "Assessment Info": ["EXP_MAIN"], // Contains values like cama_total
            "Sales History": ["EXP_TRANHIST"],
            "Land": ["EXP_LAND"],
            "Improvements": ["EXP_IMPROVE", "EXP_EXTWALL", "EXP_ROOF", "EXP_FLOOR", "EXP_HEAT"],
            "Outbuildings": ["EXP_OUTBUILD", "EXP_GARAGE", "EXP_PORCH"],
            "Photos": ["EXP_PHOTOS"]
        };

        const SECTION_ICONS = {
            "Assessment Info": "fa-file-invoice-dollar",
            "Sales History": "fa-handshake",
            "Land": "fa-tree",
            "Improvements": "fa-house",
            "Outbuildings": "fa-warehouse",
            "Photos": "fa-camera"
        };

        const USE_CARD_VIEW = ['EXP_MAIN', 'EXP_TRANHIST'];
        const ROWS_PER_PAGE = 10;
        
        // New Keys
        const LRSN_KEY = 'parcel_id'; // The unique ID for joining tables
        const SPAN_KEY = 'parc_span'; // The ID used to link to the Map

        // --- STATE ---
        let masterData = [];
        let filteredData = [];
        let dataCache = {};
        let propertyClassCodes = {};
        let currentPage = 1;
        let mapView = null;
        let parcelLayer = null;
        let highlightHandle = null;
        let e911Layer = null;

        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('search-input');
        const statusMessage = document.getElementById('status-message');
        const tableWrapper = document.getElementById('table-wrapper');
        const dataTable = document.getElementById('data-table');
        const tableInfo = document.getElementById('table-info');
        const paginationControls = document.getElementById('pagination-controls');
        const mainView = document.getElementById('main-view');
        const detailView = document.getElementById('detail-view');
        const detailContent = document.getElementById('detail-content');
        const backButton = document.getElementById('back-button');
        const filterStatus = document.getElementById('filter-status');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const leftPane = document.getElementById('left-pane');
        const toTopBtn = document.getElementById('to-top-btn');

        // --- DEFAULT SEARCH RESULT AREA DISPLAY ---
        function showInitialMessage() {
            tableWrapper.classList.add('hidden');
            statusMessage.innerHTML = '<p class="text-gray-500 text-lg text-center">Click on a parcel on the map or use the search bar to explore property data.</p>';
            statusMessage.classList.remove('hidden');
        }

        // --- INITIALIZATION ---
        async function initialize() {
            showLoading('Loading property data...');
            await initializeMap();
            await loadPropertyClassCodes();
            await loadInitialData();
            showInitialMessage(); // Changed from renderMainTable()
            loadRelatedDataInBackground();
            
            searchInput.addEventListener('input', handleSearch);
            backButton.addEventListener('click', showMainView);
            clearFilterBtn.addEventListener('click', clearMapFilter);
            
            toTopBtn.addEventListener('click', () => {
                leftPane.scrollTo({ top: 0, behavior: 'smooth' });
            });

            leftPane.addEventListener('scroll', () => {
                if (leftPane.scrollTop > 200) {
                    toTopBtn.classList.remove('opacity-0', 'invisible');
                } else {
                    toTopBtn.classList.add('opacity-0', 'invisible');
                }
            });
        }

        // --- MAP LOGIC ---
        async function initializeMap() {
            return new Promise((resolve, reject) => {
                require([
                    "esri/Map",
                    "esri/views/MapView",
                    "esri/layers/FeatureLayer",
                    "esri/layers/VectorTileLayer",
                    "esri/Basemap",
                    "esri/layers/TileLayer",
                    "esri/smartMapping/renderers/location",
                    "esri/widgets/Compass"
                ], (Map, MapView, FeatureLayer, VectorTileLayer, Basemap, TileLayer, locationRendererCreator, Compass) => {

                    async function setupMap() {
                        const imageryLayer = new TileLayer({
                            url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",
                            title: "Satellite Imagery"
                        });

                        const labelLayer = new VectorTileLayer({
                            url: "https://www.arcgis.com/sharing/rest/content/items/ba52238d338745b1a355407ec9df6768/resources/styles/root.json",
                            title: "Custom Styled Labels"
                        });

                        const satelliteBasemap = new Basemap({
                            baseLayers: [imageryLayer],
                            referenceLayers: [labelLayer],
                            title: "Imagery with Custom Labels",
                            id: "imagery-with-custom-labels"
                        });

                        const parcelLabelClass = {
                            symbol: {
                                type: "text",
                                color: "#fff",
                                haloColor: "#333333",
                                haloSize: "1pt",
                                font: { family: "Arial", size: "8pt", weight: "bold" }
                            },
                            labelPlacement: "always-horizontal",
                            labelExpressionInfo: {
                                expression: `
                                    if (IsEmpty($feature.SPAN)) {
                                        return "No SPAN Assigned to Parcel";
                                    } else {
                                        return $feature.SPAN;
                                    }
                                `
                            },
                            minScale: 5000
                        };
                        const parcelRenderer = {
                            type: "simple",
                            symbol: {
                                type: "simple-fill",
                                style: "solid",
                                color: [0, 0, 0, 0], 
                                outline: { color: [211, 211, 211, 0.9], width: "1px" }
                            }
                        };
                        parcelLayer = new FeatureLayer({
                            url: "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_OPENDATA_Cadastral_VTPARCELS_poly_standardized_parcels_SP_v1/FeatureServer/0",
                            // CHANGED: Filter for LINCOLN instead of BARRE TOWN
                            definitionExpression: "TOWN = 'LINCOLN'",
                            outFields: ["SPAN"],
                            popupEnabled: false, 
                            renderer: parcelRenderer,
                            labelingInfo: [parcelLabelClass]
                        });
                        
                        e911Layer = new FeatureLayer({
                            url: "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_OPENDATA_Emergency_ESITE_point_SP_v1/FeatureServer/0",
                            title: "E-911 Site Locations",
                            visible: false,
                            minScale: 4514,
                            outFields: ["PRIMARYADDRESS"]
                        });

                        const map = new Map({ 
                            basemap: satelliteBasemap, 
                            layers: [parcelLayer, e911Layer]
                        });

                        mapView = new MapView({
                            container: "map-view",
                            map: map,
                            // CHANGED: Coordinates for Lincoln, VT
                            center: [-72.995, 44.098], 
                            zoom: 13,
                            highlightOptions: {
                                color: "#c3d600",
                                fillOpacity: 0.4
                            },
                            popup: {
                                dockEnabled: false,
                                dockOptions: { buttonEnabled: false, breakpoint: false },
                                collapseEnabled: false,
                                actions: []
                            }
                        });
                        await mapView.when();

                        // --- Layer and Renderer Setup (Must complete before adding UI widgets) ---
                        const rendererParams = {
                            layer: e911Layer,
                            view: mapView,
                            visualVariables: {
                                type: "size"
                            }
                        };
                        const rendererResponse = await locationRendererCreator.createRenderer(rendererParams);
                        
                        const newSymbol = rendererResponse.renderer.symbol.clone();
                        newSymbol.color = "#333333";
                        newSymbol.outline = { color: "#ffffff", width: "1px" };
                        rendererResponse.renderer.symbol = newSymbol;
                        e911Layer.renderer = rendererResponse.renderer;

                        const e911LabelClass = {
                            labelExpressionInfo: {
                                expression: "$feature.PRIMARYADDRESS" 
                            },
                            symbol: {
                                type: "text",
                                color: "#2b2b2b",
                                haloColor: "#d3d3d3",
                                haloSize: 1,
                                font: {
                                    family: "Arial",
                                    size: 7,
                                    weight: "bold"
                                }
                            },
                            labelPlacement: "above-center"
                        };
                        e911Layer.labelingInfo = [e911LabelClass];

                        // --- UI Widget Setup (Moved to the end) ---
                        const compass = new Compass({
                            view: mapView
                        });
                        mapView.ui.add(compass, "top-left");

                        const toggleContainer = document.createElement("div");
                        toggleContainer.innerHTML = `
                            <label for="e911-toggle" class="flex items-center cursor-pointer p-1">
                                <input type="checkbox" id="e911-toggle" class="h-4 w-4 rounded border-gray-300 text-[#003300] focus:ring-[#003300]">
                                <span class="ml-2 text-sm font-medium text-gray-700">Show E911 Address Points</span>
                            </label>
                        `;
                        toggleContainer.className = "esri-widget bg-white shadow-md"; 
                        mapView.ui.add(toggleContainer, "top-right");

                        const e911Toggle = toggleContainer.querySelector('#e911-toggle');
                        e911Toggle.addEventListener('change', (event) => {
                            if (e911Layer) {
                                e911Layer.visible = event.target.checked;
                            }
                        });

                        // --- Map Event Listeners ---
                        // mapView.on("click...") updated for microsolve
                        mapView.on("click", (event) => {
                            mapView.hitTest(event).then((response) => {
                                const parcelResult = response.results.find(r => r.graphic && r.graphic.layer === parcelLayer);
                                
                                if (parcelResult) {
                                    const taxId = parcelResult.graphic.attributes.SPAN;
                                    
                                    if (taxId) {
                                        const taxIdStr = String(taxId).trim();
                                        
                                        // SEARCH: Look for this SPAN in our new EXP_MAIN data
                                        // We have to clean the values in masterData before comparing because they contain extra quotes
                                        const pRec = masterData.find(p => {
                                            const cleanSpan = cleanValue(p[SPAN_KEY]);
                                            return cleanSpan === taxIdStr;
                                        });

                                        if (pRec) {
                                            const lrsn = pRec[LRSN_KEY]; // Get the joining ID (parcel_id)
                                            showDetailView(lrsn);
                                        } else {
                                            showError(`No CAMA data found for parcel (Tax ID: ${taxIdStr}).`);
                                            showMainView();
                                        }
                                    }
                                } else {
                                    clearMapHighlight();
                                }
                            });
                        });
                        resolve();
                    }
                    setupMap().catch(err => reject(err));
                });
            });
        }
        
        async function highlightParcel(graphic) {
            // Atomically update the highlight: clear the old one first.
            clearMapHighlight();
            
            // Create the new highlight and set the handle once it's ready.
            const newHandle = await mapView.whenLayerView(graphic.layer).then(layerView => {
                return layerView.highlight(graphic);
            });
            highlightHandle = newHandle;
        }

        function clearMapHighlight() {
            if (highlightHandle) {
                highlightHandle.remove();
                highlightHandle = null;
            }
        }
        
        async function zoomToParcelByTaxId(taxId) {
            if (!parcelLayer || !taxId) return;
            const query = parcelLayer.createQuery();
            query.where = `SPAN = '${taxId}'`;
            query.returnGeometry = true;
            try {
                const { features } = await parcelLayer.queryFeatures(query);
                if (features.length > 0) {
                    mapView.goTo(features[0].geometry).catch(err => err.name !== "view:goto-interrupted" && console.error(err));
                    await highlightParcel(features[0]);
                }
            } catch(error) {
                console.error("Failed to zoom to feature:", error);
            }
        }
        
        function resetMapView() {
            if (mapView) {
                // CHANGED: Update to Lincoln coordinates
                mapView.goTo({ center: [-72.995, 44.098], zoom: 13 })
                    .catch(err => err.name !== "view:goto-interrupted" && console.error(err));
                clearMapHighlight();
            }
        }

        function clearMapFilter() {
            filteredData = masterData;
            currentPage = 1;
            showInitialMessage(); // Changed from renderMainTable()
            filterStatus.classList.add('hidden');
            searchInput.value = '';
            resetMapView();
        }

        // --- DATA FETCHING & HANDLING ---
        async function loadPropertyClassCodes() {
            try {
                const response = await fetch(PROPERTY_CLASS_CODES_URL);
                if (!response.ok) throw new Error(`Failed to fetch property codes: ${response.statusText}`);
                const data = await response.json();

                propertyClassCodes = {}; 

                for (const primaryType in data) {
                    if (data.hasOwnProperty(primaryType)) {
                        const secondaryTypes = data[primaryType];
                        for (const code in secondaryTypes) {
                            if (secondaryTypes.hasOwnProperty(code)) {
                                const secondaryType = secondaryTypes[code];
                                propertyClassCodes[code] = {
                                    primary: primaryType,
                                    secondary: secondaryType
                                };
                            }
                        }
                    }
                }
                console.log("Property Class Codes Lookup Table successfully created.");
            } catch (error) {
                console.error("Error loading property class codes:", error);
            }
        }
        
        async function loadInitialData() {
            try {
                await Promise.all(ESSENTIAL_FILES.map(async (file) => {
                    const response = await fetch(`${S3_BASE_URL}${file}.json`);
                    if (!response.ok) throw new Error(`Failed to load: ${file}`);
                    dataCache[file] = await response.json();
                }));
                masterData = dataCache[MASTER_FILE];
                filteredData = masterData;
            } catch (error) {
                showError('Failed to load initial property data. The application cannot start.');
                console.error(error);
            }
        }

        async function loadRelatedDataInBackground() {
            const allFiles = Object.values(RELATED_FILES).flat();
            const filesToLoad = allFiles.filter(file => !ESSENTIAL_FILES.includes(file));
            Promise.all(filesToLoad.map(async (file) => {
                try {
                    const response = await fetch(`${S3_BASE_URL}${file}.json`);
                    if (response.ok) dataCache[file] = await response.json();
                } catch (fetchError) {
                     console.error(`Could not fetch ${file}:`, fetchError);
                     dataCache[file] = [];
                }
            }));
        }

        function handleSearch() {
            resetMapView();
            filterStatus.classList.add('hidden');
            const searchTerm = searchInput.value.toLowerCase();

            // If the search term is empty, show the initial message and stop.
            if (!searchTerm) {
                showInitialMessage();
                return;
            }
            
            // Otherwise, filter the data and render the results table.
            filteredData = masterData.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(searchTerm)));
            currentPage = 1;
            renderMainTable();
        }

        // --- HIERARCHICAL VIEW LOGIC ---
        // updated for microsolve
        async function showDetailView(lrsn) {
            // Find the record using the raw ID
            const parcelData = masterData.find(p => p[LRSN_KEY] === lrsn);
            if (!parcelData) return;

            const cleanLrsn = cleanValue(lrsn);
            const spanId = cleanValue(parcelData[SPAN_KEY]);

            // Zoom map to this parcel
            if(spanId) await zoomToParcelByTaxId(spanId);

            mainView.classList.add('hidden');
            detailView.classList.remove('hidden');

            // --- BUILD BASIC DETAILS FROM EXP_MAIN ---
            const address = cleanValue(parcelData.prop_locat);
            const owner = cleanValue(parcelData.owner_name);
            const totalValue = parseFloat(cleanValue(parcelData.cama_total)).toLocaleString('en-US', {style:'currency', currency:'USD'});
            const landValue = parseFloat(cleanValue(parcelData.cama_land)).toLocaleString('en-US', {style:'currency', currency:'USD'});
            const dwellValue = parseFloat(cleanValue(parcelData.cama_dwell)).toLocaleString('en-US', {style:'currency', currency:'USD'});
            const acres = cleanValue(parcelData.factorj); // Assuming 'factorj' is acres based on sample value 0.22/0.32
            const builtYear = cleanValue(parcelData.year_built) || 'N/A'; // We need to check EXP_IMPROVE later for this

            let html = `<div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center mb-4">
                                <i class="fa-solid fa-circle-info mr-3" style="color: #003300;"></i>Property Details
                            </h2>
                            <p class="text-lg text-[#003300] font-bold">${address}</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mt-4">
                                <div>
                                    <p class="mt-1 text-sm text-gray-600"><strong>Owner:</strong> ${owner}</p>
                                    <p class="mt-1 text-sm text-gray-600"><strong>Parcel ID:</strong> ${cleanLrsn}</p>
                                    <p class="mt-1 text-sm text-gray-600"><strong>SPAN:</strong> ${spanId}</p>
                                    <p class="mt-1 text-sm text-gray-600"><strong>Acres:</strong> ${acres}</p>
                                </div>
                                <div>
                                    <p class="mt-1 text-sm text-gray-600"><strong>Total Value:</strong> ${totalValue}</p>
                                    <p class="mt-1 text-sm text-gray-600"><strong>Land Value:</strong> ${landValue}</p>
                                    <p class="mt-1 text-sm text-gray-600"><strong>Dwelling Value:</strong> ${dwellValue}</p>
                                </div>
                            </div>
                        </div>`;
            
            // Placeholder for where we will loop through other files later
            html += `<div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400">
                        <p class="text-yellow-700">Detailed sections (Improvements, Land, etc.) will be configured in the next steps.</p>
                     </div>`;

            detailContent.innerHTML = html;
            leftPane.scrollTo(0, 0);
        }
        
        function showMainView() {
            detailView.classList.add('hidden');
            mainView.classList.remove('hidden');
            resetMapView();
        }

        // --- UI RENDERING ---
        function renderMainTable() {
            statusMessage.classList.add('hidden');
            tableWrapper.classList.remove('hidden');
            renderMainTableHeaders();
            renderMainTablePage();
            renderPagination();
        }

        function renderMainTableHeaders() {
            const tableHead = dataTable.querySelector('thead');
            tableHead.innerHTML = '';
            if (masterData.length === 0) return;
            const headers = ['LRSN', 'Address', 'City', 'Zip'];
            const headerRow = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = h;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
        }

        // updated function renderMainTablePage for microsolve
        function renderMainTablePage() {
            const tableBody = dataTable.querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">No properties found.</td></tr>`;
                updateTableInfo(0, 0);
                return;
            }

            const startIndex = (currentPage - 1) * ROWS_PER_PAGE;
            const endIndex = startIndex + ROWS_PER_PAGE;
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'main-table-row';
                // Store the clean ID for clicking
                const rawId = row[LRSN_KEY]; 
                tr.dataset.lrsn = rawId; 

                // Clean the display values
                const displayId = cleanValue(row[LRSN_KEY]);
                const address = cleanValue(row.prop_locat); 
                const city = cleanValue(row.city);
                const zip = cleanValue(row.zip_code);

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${city}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${zip}</td>
                `;
                
                // Pass the raw ID to the detail view (we'll handle cleaning inside showDetailView later)
                tr.addEventListener('click', () => showDetailView(rawId));
                tableBody.appendChild(tr);
            });

            updateTableInfo(startIndex, endIndex);
        }

        function renderPagination() {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(filteredData.length / ROWS_PER_PAGE);
            if (totalPages <= 1) return;
            let html = `<div class="text-sm text-gray-700">Page <span class="font-medium">${currentPage}</span> of <span class="font-medium">${totalPages}</span></div>`;
            html += `<div class="flex items-center gap-2">
                        <button class="pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                        <button class="pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                     </div>`;
            paginationControls.innerHTML = html;
            document.querySelectorAll('.pagination-btn').forEach(button => {
                button.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed';
                button.addEventListener('click', (e) => {
                    currentPage = parseInt(e.target.dataset.page);
                    renderMainTablePage();
                    renderPagination();
                    dataTable.scrollIntoView({ behavior: 'smooth' });
                });
            });
        }

        // --- UTILITY FUNCTIONS ---
        function formatDateString(value) {
            return (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) ? value.substring(0, 10) : value;
        }

        function formatLastUpdateDate(dateString) {
            if (!dateString || dateString === 'N/A') {
                return 'N/A';
            }
            try {
                const date = new Date(dateString);
                // An invalid date's time is NaN
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            } catch (error) {
                console.error("Could not format date:", dateString, error);
                return 'N/A';
            }
        }

        // added cleanValue for microsolve json data
        function cleanValue(val) {
            if (val === null || val === undefined) return '';
            const str = String(val).trim();
            // Remove surrounding double quotes if they exist (e.g. "VT" -> VT)
            if (str.startsWith('"') && str.endsWith('"')) {
                return str.substring(1, str.length - 1);
            }
            return str;
        }

        function createDetailList(records) {
            if (!records || records.length === 0) return '';
            let listHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 text-sm">`;
            const record = records[0]; 
            for (const key in record) {
                const value = formatDateString(String(record[key]).trim());
                if (value && value !== '\u0000') {
                    const fKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    listHtml += `<div class="detail-card"><strong class="block text-xs text-gray-500">${fKey}</strong><span class="text-gray-900">${value}</span></div>`;
                }
            }
            return listHtml + `</div>`;
        }

        function createHtmlTable(records) {
            if (!records || records.length === 0) return '<p class="text-sm text-gray-500">No records found.</p>';
            const headers = Object.keys(records[0]);
            let table = '<div class="overflow-x-auto table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
            headers.forEach(h => table += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h.replace(/_/g, ' ')}</th>`);
            table += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            records.forEach(r => {
                table += '<tr>';
                headers.forEach(h => table += `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatDateString(r[h])}</td>`);
                table += '</tr>';
            });
            return table + '</tbody></table></div>';
        }

        function drawSketch(lrsn, canvas) {
            const vectors = (dataCache['Sketch_Vector'] || []).filter(v => v.lrsn === lrsn || v.LRSN === lrsn);
            if (vectors.length === 0) return;
            const ctx = canvas.getContext('2d');
            const padding = 40;
            const segments = vectors.reduce((acc, v) => {
                acc[v.segment_id] = acc[v.segment_id] || [];
                acc[v.segment_id].push(v);
                return acc;
            }, {});
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity, cX = 0, cY = 0;
            Object.values(segments).forEach(sVecs => {
                cX = 0; cY = 0;
                sVecs.forEach(v => {
                    const run = parseFloat(v.run) || 0, rise = parseFloat(v.rise) || 0;
                    minX = Math.min(minX, cX); minY = Math.min(minY, cY);
                    maxX = Math.max(maxX, cX); maxY = Math.max(maxY, cY);
                    cX += run; cY -= rise;
                    minX = Math.min(minX, cX); minY = Math.min(minY, cY);
                    maxX = Math.max(maxX, cX); maxY = Math.max(maxY, cY);
                });
            });
            const sketchW = maxX - minX, sketchH = maxY - minY;
            if (sketchW === 0 || sketchH === 0) return;
            const scale = Math.min((canvas.width - padding * 2) / sketchW, (canvas.height - padding * 2) / sketchH);
            const offX = (canvas.width - sketchW * scale) / 2 - minX * scale;
            const offY = (canvas.height - sketchH * scale) / 2 - minY * scale;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 2; ctx.font = '10px Inter'; ctx.fillStyle = '#4b5563';
            Object.values(segments).forEach(sVecs => {
                cX = 0; cY = 0;
                ctx.beginPath();
                ctx.moveTo(offX, offY);
                sVecs.forEach(v => {
                    const run = parseFloat(v.run) || 0, rise = parseFloat(v.rise) || 0, len = parseFloat(v.vector_length) || 0;
                    const sX = cX * scale + offX, sY = cY * scale + offY;
                    cX += run; cY -= rise;
                    const eX = cX * scale + offX, eY = cY * scale + offY;
                    ctx.lineTo(eX, eY);
                    if (len > 0) {
                        const mX = (sX + eX) / 2, mY = (sY + eY) / 2, ang = Math.atan2(eY - sY, eX - sX);
                        const lOffX = Math.sin(ang) * 10, lOffY = -Math.cos(ang) * 10;
                        ctx.save();
                        ctx.translate(mX + lOffX, mY + lOffY);
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        ctx.fillText(len.toFixed(1), 0, 0);
                        ctx.restore();
                    }
                });
                ctx.stroke();
            });
        }

        function showLoading(message) {
            statusMessage.innerHTML = `<div class="flex flex-col items-center gap-4"><div class="loader h-12 w-12 rounded-full border-4 border-gray-200"></div><p class="text-gray-500 text-lg">${message}</p></div>`;
            statusMessage.classList.remove('hidden');
            tableWrapper.classList.add('hidden');
        }

        function showError(message) {
            statusMessage.innerHTML = `<p class="text-red-600 bg-red-100 p-4 rounded-md">${message}</p>`;
        }
        
        function updateTableInfo(startIndex, endIndex) {
            const end = Math.min(endIndex, filteredData.length);
            const start = filteredData.length > 0 ? startIndex + 1 : 0;
            tableInfo.textContent = `Showing ${start} to ${end} of ${filteredData.length} properties.`;
        }

        function getNeighborhoodData(lrsn) {
            const results = {
                main: null,
                res: null,
                com: null,
                land: null,
                landDetails: [],
                hfFactors: []
            };

            // Step 1: Find the parcel's neighborhood ID from Parcel_Main
            const parcelMainRecord = (dataCache['Parcel_Main'] || []).find(p => 
                (p.lrsn && String(p.lrsn).trim() === String(lrsn).trim()) || 
                (p.LRSN && String(p.LRSN).trim() === String(lrsn).trim())
            );
            if (!parcelMainRecord) {
                console.log("Could not find Parcel_Main record for LRSN:", lrsn);
                return results; // Return empty results
            }
            
            const neighborhoodId = parcelMainRecord.neighborhood || parcelMainRecord.NEIGHBORHOOD;
            if (!neighborhoodId) {
                console.log("Neighborhood ID not found on Parcel_Main record for LRSN:", lrsn);
                return results;
            }

            // Step 2: Use the neighborhood ID to get the main neighborhood records
            results.main = (dataCache['Nbhd_Main'] || []).find(r => (r.neighborhood || r.NEIGHBORHOOD) == neighborhoodId);
            results.res = (dataCache['Nbhd_Res'] || []).find(r => (r.neighborhood || r.NEIGHBORHOOD) == neighborhoodId);
            results.com = (dataCache['Nbhd_Com'] || []).find(r => (r.neighborhood || r.NEIGHBORHOOD) == neighborhoodId);
            results.land = (dataCache['Nbhd_Land'] || []).find(r => (r.neighborhood || r.NEIGHBORHOOD) == neighborhoodId);

            // Step 3: Use model numbers from the main records to get detail records
            if (results.land) {
                const landModelSerial = results.land.land_model_serial || results.land.LAND_MODEL_SERIAL;
                if (landModelSerial) {
                    results.landDetails = (dataCache['Nbhd_Land_Detail'] || []).filter(
                        r => (r.model_ser_numb === landModelSerial || r.MODEL_SER_NUMB === landModelSerial) && 
                             ((r.neighborhood || r.NEIGHBORHOOD) == neighborhoodId)
                    );
                }
            }

            if (results.res) {
                const hfModelNumber = results.res.hf_model_number || results.res.HF_MODEL_NUMBER;
                if (hfModelNumber) {
                    results.hfFactors = (dataCache['Nbhd_HF'] || []).filter(r => r.hf_model_number === hfModelNumber || r.HF_MODEL_NUMBER === hfModelNumber);
                }
            }

            return results;
        }

        initialize();
    });
    </script>
</body>
</html>