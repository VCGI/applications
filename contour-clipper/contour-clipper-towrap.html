<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Vermont 1ft Contour Clipper</title>
  <style>
    /*begin embedded styles for contour clipper*/
    html, body, #viewDiv { padding: 0; margin: 0; height: 100%; width: 100%; }
    #infoDiv { padding: 12px; width: 300px; background-color: white; }
    #infoDiv * { width: 100%; box-sizing: border-box; margin-bottom: 8px; }
    #infoDiv h3 { margin-top: 0; }
    #warning { color: #d9534f; font-weight: bold; display: none; }
    #webhookUrl { word-wrap: break-word; background-color: #f0f0f0; padding: 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; min-height: 50px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    #submitBtn { margin-top: 12px; background-color: #0079c1; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 1em; }
    #submitBtn:disabled { background-color: #cccccc; color: #666666; cursor: not-allowed; }
    #statusMessage { margin-top: 8px; font-weight: bold; min-height: 1.2em; }
    /*end embedded styles for contour clipper*/
  </style>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/VectorTileLayer",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Sketch",
      "esri/widgets/BasemapToggle",
      "esri/geometry/geometryEngine",
      "esri/geometry/projection",
      "esri/widgets/Search"
    ], (Map, MapView, VectorTileLayer, GraphicsLayer, Sketch, BasemapToggle, geometryEngine, projection, Search) => {

      const map = new Map({
        basemap: "topo"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map
      });

      const contourLayer = new VectorTileLayer({
        url: "https://tiles.arcgis.com/tiles/BkFxaEFNwHqX3tAw/arcgis/rest/services/VECTOR_VCGI_CN1TGEN_WM_v1/VectorTileServer",
        title: "Vermont 1ft Contours"
      });
      
      const graphicsLayer = new GraphicsLayer();

      map.addMany([contourLayer, graphicsLayer]);

      // Get DOM elements
      const areaDisplay = document.getElementById("area");
      const warningMessage = document.getElementById("warning");
      const webhookUrlDisplay = document.getElementById("webhookUrl");
      const formatSelector = document.getElementById("formatSelect");
      const submitButton = document.getElementById("submitBtn");
      const statusMessage = document.getElementById("statusMessage");

      const blueSymbol = { type: "simple-fill", color: [51, 153, 255, 0.4], outline: { color: "#3399FF", width: 2 } };
      const redSymbol = { type: "simple-fill", color: [255, 51, 51, 0.4], outline: { color: "#FF3333", width: 2 } };

      view.when(() => {
        projection.load().then(() => {
            view.goTo({
              center: [-72.6, 44.0],
              zoom: 8
            });

            const searchWidget = new Search({
              view: view,
              sources: [{
                url: "https://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/GCS_E911_ESITE_SP_v2/GeocodeServer",
                name: "Vermont E911 Address Locator",
                placeholder: "Search for an address"
              }],
              includeDefaultSources: false,
              locationEnabled: false,
              popupEnabled: false
            });
            
            view.ui.add(searchWidget, {
              position: "top-left",
              index: 0
            });

            const sketch = new Sketch({
              layer: graphicsLayer,
              view: view,
              availableCreateTools: ["rectangle"],
              creationMode: "update",
              visibleElements: {
                settingsMenu: false,
                selectionTools: {
                  "lasso-selection": false,
                  "rectangle-selection": false
                }
              }
            });
            view.ui.add(sketch, "top-right");

            setTimeout(() => {
                sketch.create("rectangle");
            }, 100);


            const basemapToggle = new BasemapToggle({
              view: view,
              nextBasemap: "hybrid"
            });
            view.ui.add(basemapToggle, "bottom-left");

            view.ui.add(document.getElementById("infoDiv"), "top-right");
            
            sketch.on(["create", "update"], (event) => {
              const graphic = event.graphic || (event.graphics && event.graphics[0]);
              if (!graphic) return;

              // Validate while drawing or reshaping
              if (event.state === "active") {
                validateGraphic(graphic, false); 
              }

              if (event.state === "complete") {
                 // Prevent new graphics from being created if one already exists
                if(event.type === "create" && graphicsLayer.graphics.length > 1){
                   graphicsLayer.remove(graphicsLayer.graphics.getItemAt(0));
                }
                validateGraphic(graphic, true); 
              }
            });

            sketch.on("delete", () => {
              resetUI();

              sketch.create("rectangle");
            });
        });
      });
      
      formatSelector.addEventListener("change", () => {
        if (graphicsLayer.graphics.length > 0) {
          generateWebhookUrl(graphicsLayer.graphics.getItemAt(0));
        }
      });

      submitButton.addEventListener("click", submitRequest);
      
      function validateGraphic(graphic, generateUrl) {
        const area = geometryEngine.geodesicArea(graphic.geometry, "square-miles");
        const isValid = area > 0 && area <= 1.0;
        
        areaDisplay.textContent = `Area: ${area.toFixed(4)} sq mi`;
        warningMessage.style.display = area > 1.0 ? "block" : "none";
        statusMessage.textContent = "";
        submitButton.disabled = !isValid;
        graphic.symbol = isValid ? blueSymbol : redSymbol;

        if (generateUrl) {
          generateWebhookUrl(graphic);
        }
      }

      function resetUI() {
          areaDisplay.textContent = "Area: 0.00 sq mi";
          warningMessage.style.display = "none";
          webhookUrlDisplay.textContent = "Draw a box to submit clipping request.";
          statusMessage.textContent = "";
          submitButton.disabled = true;
      }
      
      function getBboxAsGeoJson(geometry) {
        const wgs84Geometry = projection.project(geometry, { wkid: 4326 });
        
        const coordinates = wgs84Geometry.rings.map(ring =>
            ring.map(point => [
                parseFloat(point[0].toFixed(15)),
                parseFloat(point[1].toFixed(15))
            ])
        );

        const geoJson = {
          type: "Polygon",
          coordinates: coordinates
        };
        
        return JSON.stringify(geoJson);
      }

      function generateWebhookUrl(graphic) {
        if (!graphic || !graphic.geometry) {
          webhookUrlDisplay.textContent = "Draw a box to generate a URL.";
          return;
        }

        const bboxGeoJson = getBboxAsGeoJson(graphic.geometry);
        const format = formatSelector.value;
        const baseURL = "https://dev.maps.vcgi.vermont.gov/fmeserver";
        
        const encodedBbox = encodeURIComponent(bboxGeoJson);
        
        const webhookURL = `${baseURL}?format=${format}&bbox=${encodedBbox}`;
        webhookUrlDisplay.textContent = webhookURL;
      }
      
      function submitRequest() {
        if (graphicsLayer.graphics.length === 0 || submitButton.disabled) {
            statusMessage.textContent = "Please draw a valid box first.";
            statusMessage.style.color = "#D83020";
            return;
        }

        const graphic = graphicsLayer.graphics.getItemAt(0);
        const format = formatSelector.value;
        const postURL = "https://dev.maps.vcgi.vermont.gov/fmeserver";
        
        const bboxGeoJson = getBboxAsGeoJson(graphic.geometry);

        const postData = new URLSearchParams();
        postData.append("format", format);
        postData.append("bbox", bboxGeoJson);

        statusMessage.textContent = "Submitting request...";
        statusMessage.style.color = "#005a9c";
        submitButton.disabled = true;

        fetch(postURL, {
            method: "POST",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: postData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.text();
        })
        .then(data => {
            console.log("Success response:", data);
            statusMessage.textContent = "Request submitted successfully!";
            statusMessage.style.color = "#2E8540";
        })
        .catch(error => {
            console.error("Submission error:", error);
            statusMessage.textContent = `Submission failed. ${error.message}`;
            statusMessage.style.color = "#D83020";
        })
        .finally(() => {
            if (graphicsLayer.graphics.length > 0) {
                 const currentArea = geometryEngine.geodesicArea(graphicsLayer.graphics.getItemAt(0).geometry, "square-miles");
                 if (currentArea <= 1.0) {
                     submitButton.disabled = false;
                 }
            }
        });
      }
    });
  </script>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="infoDiv" class="esri-widget">
    <h3>Vermont 1ft Contour Clipper</h3>
    <p>Use the rectangle tool to select area to clip (1 square mile max).</p>
    <div id="area">Area: 0.00 sq mi</div>
    <div id="warning">Clip area is too large.</div>
    <hr>
    <label for="formatSelect">1. Select Data Format:</label>
    <select id="formatSelect">
      <option value="SHP">Shapefile</option>
      <option value="DWG">DWG</option>
      <option value="DXF">DXF</option>
      <option value="FGDB">File Geodatabase</option>
    </select>
    <label>2. Generated Webhook URL:</label>
    <div id="webhookUrl">Draw a box to generate a URL.</div>
    <hr>
    <button id="submitBtn" disabled>Submit Request</button>
    <div id="statusMessage"></div>
  </div>
</body>
</html>