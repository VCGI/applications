<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>VT CAMA Sample Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- ArcGIS Map CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <style>
        html, body {
            overflow: hidden; /* Prevent body scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #map-view {
            height: 100%; /* Make map fill its container */
            width: 100%;
        }

        /* More specific rules to remove the focus outline from the map and its children */
        #map-view:focus,
        #map-view:focus-within,
        .esri-view-surface--is-focused {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Remove blue highlight on tap/click for all div elements */
        div {
            -webkit-tap-highlight-color: transparent;
        }

        /* Remove default focus outline for div elements */
        div:focus {
            outline: none;
        }

        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .main-table-row { cursor: pointer; }
        .main-table-row:hover { background-color: #e6f0e6; } /* Updated from blue-50 */
        .related-section h3 {
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        #sketch-canvas {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
        }
        .detail-card {
            background-color: #f9fafb; /* gray-50 */
            border-left: 4px solid #003300; /* Updated from indigo-600 */
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
        }
        /* Style for the hover popup */
        .esri-popup .esri-popup__main-container {
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex h-screen">
        <!-- Left Pane (Scrollable Content) -->
        <div class="w-3/5 h-screen overflow-y-auto relative" id="left-pane">
            <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                <!-- Header Section -->
                <header class="mb-8 text-left">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Vermont CAMA Sample Explorer</h1>
                    <p class="mt-2 text-md text-gray-600">Click a parcel on the map or search below to explore property data. <b>For demo purposes only.</b></p>
                </header>

                <!-- Search and Main Table Section -->
                <div id="main-view">
                    <!-- Filter Status -->
                    <div id="filter-status" class="hidden mb-4 p-4 bg-[#e6f0e6] border-l-4 border-[#003300] text-[#003300] rounded-md flex justify-between items-center">
                        <p>Showing data for parcel selected on map.</p>
                        <button id="clear-filter-btn" class="font-bold hover:underline">Clear Map Filter</button>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Search by Address or LRSN</label>
                        <input type="text" id="search-input" placeholder="e.g., 'Main St' or '1234'" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#003300] focus:border-[#003300]">
                    </div>

                    <main id="data-container" class="bg-white p-4 rounded-lg shadow-md min-h-[400px]">
                        <div id="status-message" class="flex items-center justify-center h-full">
                            <!-- Status message will be rendered here -->
                        </div>
                        <div id="table-wrapper" class="hidden">
                            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                                <h2 class="text-xl font-semibold text-gray-800">Properties</h2>
                                <div id="table-info" class="text-sm text-gray-600"></div>
                            </div>
                            <div class="overflow-x-auto table-container">
                                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50"></thead>
                                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                            <div id="pagination-controls" class="mt-4 flex justify-between items-center"></div>
                        </div>
                    </main>
                </div>

                <!-- Detail View Section (Initially Hidden) -->
                <div id="detail-view" class="hidden">
                    <button id="back-button" class="mb-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#003300] hover:bg-[#002a00] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#003300]">
                        &larr; Back to Search Results
                    </button>
                    <div id="detail-content" class="space-y-8">
                        <!-- Details will be loaded here -->
                    </div>
                </div>

                <!-- Disclaimer Section -->
                <div class="mt-8 text-left text-xs text-gray-500 border-t pt-4">
                    <p>Parcel and CAMA data here are <b>for reference only</b> and are sourced from Vermont municipalities. Neither the State of Vermont nor the contributors of data, services, and products provided here or through the Vermont Open Geodata Portal shall be held liable for any improper or incorrect use of those data, services, and products and assume no responsibility for anyone's use of those data, services, and products. In no event shall the State of Vermont or the contributors be liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement or substitute goods or services; loss of use, data, or profits; or business interruption) however caused and on any theory.</p>
                </div>
            </div>
             <!-- Return to Top Button -->
            <button id="to-top-btn" title="Go to top" class="opacity-0 invisible fixed bottom-8 right-[41%] z-20 bg-[#003300] text-white rounded-full text-2xl w-14 h-14 flex items-center justify-center shadow-lg hover:bg-[#002a00] transition-all duration-300">
                <i class="fa-solid fa-circle-arrow-up"></i>
            </button>
        </div>

        <!-- Right Pane (Fixed Map) -->
        <div class="w-2/5 h-screen">
            <!-- Map Container -->
            <div id="map-view" class="shadow-lg"></div>
        </div>
    </div>
    
    <!-- ArcGIS Map JS -->
    <script src="https://js.arcgis.com/4.29/"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const S3_BASE_URL = 'https://s3.us-east-2.amazonaws.com/vtopendata-prd/_Other/CAMA/sample/';
        const MASTER_FILE = 'Site_Address';
        const ESSENTIAL_FILES = ['Site_Address', 'Parcel_Main']; // Files needed for initial load
        const RELATED_FILES = {
            "Parcel & Legal": ["Parcel_Main", "Legal"],
            "Valuation": ["Valuation_History", "Valuation_Detail", "Cap_Distributions", "Influence_Mods"],
            "Sales & Transfers": ["Transfer"],
            "Buildings & Improvements": ["Improvements", "Imp_Ext_Features", "Permits"],
            "Commercial Buildings": ["CI_Building", "CI_Floors", "CI_Plumbing", "CI_Special", "CI_Unit_Cost", "CI_Uses"],
            "Residential Buildings": ["R_Floor", "R_Man_Housing"],
            "Land Details": ["Land_Site", "Land_Detail", "Land_Influence"],
            "Neighborhood": ["Nbhd_Main", "Nbhd_Res", "Nbhd_Com", "Nbhd_HF", "Nbhd_Land", "Nbhd_Land_Detail"],
            "Sketches & Images": ["Sketch_Main", "Sketch_Vector", "Sketch_Segment", "Sketch_OB", "Sketch_Notes", "Sketch_Labels", "Image_Directory"],
        };
        const USE_CARD_VIEW = ['Parcel_Main', 'Land_Detail', 'Land_Site', 'Nbhd_Main', 'Transfer'];
        const ROWS_PER_PAGE = 10;
        const LRSN_KEY = 'LRSN';

        // --- STATE ---
        let masterData = [];
        let filteredData = [];
        let dataCache = {};
        let currentPage = 1;
        let mapView = null;
        let parcelLayer = null;
        let highlightHandle = null;

        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('search-input');
        const statusMessage = document.getElementById('status-message');
        const tableWrapper = document.getElementById('table-wrapper');
        const dataTable = document.getElementById('data-table');
        const tableInfo = document.getElementById('table-info');
        const paginationControls = document.getElementById('pagination-controls');
        const mainView = document.getElementById('main-view');
        const detailView = document.getElementById('detail-view');
        const detailContent = document.getElementById('detail-content');
        const backButton = document.getElementById('back-button');
        const filterStatus = document.getElementById('filter-status');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const leftPane = document.getElementById('left-pane');
        const toTopBtn = document.getElementById('to-top-btn');

        // --- INITIALIZATION ---
        async function initialize() {
            showLoading('Loading property data...');
            await initializeMap();
            await loadInitialData();
            renderMainTable();
            loadRelatedDataInBackground();
            
            searchInput.addEventListener('input', handleSearch);
            backButton.addEventListener('click', showMainView);
            clearFilterBtn.addEventListener('click', clearMapFilter);
            
            // "Return to Top" button logic
            toTopBtn.addEventListener('click', () => {
                leftPane.scrollTo({ top: 0, behavior: 'smooth' });
            });

            leftPane.addEventListener('scroll', () => {
                if (leftPane.scrollTop > 200) {
                    toTopBtn.classList.remove('opacity-0', 'invisible');
                } else {
                    toTopBtn.classList.add('opacity-0', 'invisible');
                }
            });
        }

        // --- MAP LOGIC ---
        async function initializeMap() {
            return new Promise((resolve, reject) => {
                require([
                    "esri/Map",
                    "esri/views/MapView",
                    "esri/layers/FeatureLayer"
                ], (Map, MapView, FeatureLayer) => {
                    // --- UPDATED RENDERER ---
                    // Use a solid, but fully transparent fill. This makes the
                    // interior of the polygon clickable without being visible.
                    const parcelRenderer = {
                        type: "simple",
                        symbol: {
                            type: "simple-fill",
                            style: "solid",
                            color: [0, 0, 0, 0], // RGBA color, Alpha=0 is fully transparent
                            outline: {
                                color: [211, 211, 211, 0.9], // Light grey outline
                                width: "2px"
                            }
                        }
                    };

                    parcelLayer = new FeatureLayer({
                        url: "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_OPENDATA_Cadastral_VTPARCELS_poly_standardized_parcels_SP_v1/FeatureServer/0",
                        definitionExpression: "TOWN = 'BARRE TOWN'",
                        outFields: ["SPAN"],
                        popupEnabled: false, // We will control popups manually
                        renderer: parcelRenderer
                    });

                    const map = new Map({
                        basemap: "satellite",
                        layers: [parcelLayer]
                    });

                    mapView = new MapView({
                        container: "map-view",
                        map: map,
                        center: [-72.485, 44.187], // Centered on Barre Town, VT
                        zoom: 13,
                        popup: {
                            dockEnabled: false,
                            dockOptions: {
                                buttonEnabled: false,
                                breakpoint: false
                            },
                            collapseEnabled: false,
                            actions: []
                        }
                    });

                    mapView.when(() => {
                        let lastHoveredGraphic = null;

                        // Hover Popup Logic
                        mapView.on("pointer-move", (event) => {
                            mapView.hitTest(event).then((response) => {
                                const parcelResult = response.results.find(result => result.graphic && result.graphic.layer === parcelLayer);

                                if (parcelResult) {
                                    if (lastHoveredGraphic && lastHoveredGraphic.uid === parcelResult.graphic.uid) {
                                        return;
                                    }
                                    lastHoveredGraphic = parcelResult.graphic;
                                    document.getElementById('map-view').style.cursor = 'pointer';

                                    const taxId = parcelResult.graphic.attributes.SPAN;
                                    let popupContent = `SPAN: ${taxId}`;

                                    const taxIdStr = String(taxId).trim();
                                    const parcelMainRecord = (dataCache['Parcel_Main'] || []).find(p => {
                                        const recordTaxId = p.tax_bill_id || p.TAX_BILL_ID;
                                        return recordTaxId !== undefined && String(recordTaxId).trim() === taxIdStr;
                                    });

                                    if (parcelMainRecord) {
                                        const lrsn = parcelMainRecord.lrsn || parcelMainRecord.LRSN;
                                        if (lrsn) {
                                            const lrsnStr = String(lrsn);
                                            const addressRecord = masterData.find(p => (String(p.LRSN) === lrsnStr || String(p.lrsn) === lrsnStr));
                                            if (addressRecord && addressRecord.FreeFormAddr) {
                                                popupContent = `<strong>${addressRecord.FreeFormAddr}</strong><br><span class='text-gray-500 text-xs'>SPAN: ${taxId}</span>`;
                                            }
                                        }
                                    }
                                    
                                    mapView.popup.open({
                                        title: "Parcel Information",
                                        content: popupContent,
                                        location: parcelResult.mapPoint,
                                    });

                                } else {
                                    if (lastHoveredGraphic) {
                                        mapView.popup.close();
                                        lastHoveredGraphic = null;
                                        document.getElementById('map-view').style.cursor = 'default';
                                    }
                                }
                            });
                        });

                        // Click to Filter Logic
                        mapView.on("click", (event) => {
                            mapView.hitTest(event).then((response) => {
                                if (highlightHandle) {
                                    highlightHandle.remove();
                                    highlightHandle = null;
                                }

                                const parcelResult = response.results.find(result => result.graphic && result.graphic.layer === parcelLayer);
                                if (parcelResult) {
                                    const taxId = parcelResult.graphic.attributes.SPAN;
                                    if (taxId) {
                                        const taxIdStr = String(taxId).trim();
                                        const parcelMainRecord = (dataCache['Parcel_Main'] || []).find(p => {
                                            const recordTaxId = p.tax_bill_id || p.TAX_BILL_ID;
                                            return recordTaxId !== undefined && String(recordTaxId).trim() === taxIdStr;
                                        });

                                        if (parcelMainRecord) {
                                            const lrsn = parcelMainRecord.lrsn || parcelMainRecord.LRSN;
                                            if (lrsn) {
                                                const lrsnStr = String(lrsn);
                                                // Check if there is a corresponding record in the main address file
                                                const masterRecord = masterData.find(p => String(p.LRSN) === lrsnStr || String(p.lrsn) === lrsnStr);
                                                if (masterRecord) {
                                                    // If a record is found, show its detail view
                                                    showDetailView(lrsn);
                                                } else {
                                                    // If no main record, show an error and reset to the main table view
                                                    showError(`No address data found for the selected parcel (Tax ID: ${taxIdStr}).`);
                                                    showMainView();
                                                }
                                            } else {
                                                showError(`Could not link selected parcel to property details (missing LRSN).`);
                                                showMainView();
                                            }
                                        } else {
                                            showError(`No detailed CAMA data found for the selected parcel (Tax ID: ${taxIdStr}).`);
                                            showMainView();
                                        }
                                    }
                                }
                            });
                        });
                        resolve();
                    }).catch(reject);
                });
            });
        }
        
        function highlightParcel(graphic) {
            mapView.whenLayerView(graphic.layer).then(layerView => {
                highlightHandle = layerView.highlight(graphic);
            });
        }

        function clearMapHighlight() {
            if(highlightHandle) {
                highlightHandle.remove();
                highlightHandle = null;
            }
        }
        
        async function zoomToParcelByTaxId(taxId) {
            if (!parcelLayer || !taxId) return;
            if (highlightHandle) {
                highlightHandle.remove();
                highlightHandle = null;
            }
            const query = parcelLayer.createQuery();
            query.where = `SPAN = '${taxId}'`;
            query.returnGeometry = true;
            try {
                const { features } = await parcelLayer.queryFeatures(query);
                if (features.length > 0) {
                    const feature = features[0];
                    mapView.goTo(feature.geometry).catch(error => {
                        if (error.name !== "view:goto-interrupted") {
                            console.error(error);
                        }
                    });
                    highlightParcel(feature);
                }
            } catch(error) {
                console.error("Failed to query or zoom to feature:", error);
            }
        }
        
        function resetMapView() {
            if (mapView) {
                mapView.goTo({
                    center: [-72.485, 44.187], // Centered roughly on Barre Town, VT
                    zoom: 13 // orig 12
                }).catch(error => {
                    if (error.name !== "view:goto-interrupted") {
                        console.error(error);
                    }
                });
                clearMapHighlight();
            }
        }

        function clearMapFilter() {
            filteredData = masterData;
            currentPage = 1;
            renderMainTable();
            filterStatus.classList.add('hidden');
            searchInput.value = '';
            resetMapView(); // Return map to default extent and clear highlight
            statusMessage.classList.add('hidden');
            tableWrapper.classList.remove('hidden');
        }

        // --- DATA FETCHING & HANDLING ---
        async function loadInitialData() {
            try {
                await Promise.all(ESSENTIAL_FILES.map(async (file) => {
                    const response = await fetch(`${S3_BASE_URL}${file}.json`);
                    if (!response.ok) throw new Error(`Failed to load essential file: ${file}`);
                    dataCache[file] = await response.json();
                }));
                masterData = dataCache[MASTER_FILE];
                filteredData = masterData;
            } catch (error) {
                showError('Failed to load initial property data. The application cannot start.');
                console.error(error);
            }
        }

        async function loadRelatedDataInBackground() {
            const allFiles = Object.values(RELATED_FILES).flat();
            const filesToLoad = allFiles.filter(file => !ESSENTIAL_FILES.includes(file));
            
            Promise.all(filesToLoad.map(async (file) => {
                try {
                    const response = await fetch(`${S3_BASE_URL}${file}.json`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    dataCache[file] = await response.json();
                } catch (fetchError) {
                     console.error(`Could not fetch or process ${file}:`, fetchError);
                     dataCache[file] = [];
                }
            }));
        }

        function handleSearch() {
            clearMapFilter();
            const searchTerm = searchInput.value.toLowerCase();
            if(!searchTerm) {
                filteredData = masterData;
            } else {
                filteredData = masterData.filter(row =>
                    Object.values(row).some(value =>
                        String(value).toLowerCase().includes(searchTerm)
                    )
                );
            }
            currentPage = 1;
            renderMainTable();
        }

        // --- HIERARCHICAL VIEW LOGIC ---
        function showDetailView(lrsn) {
            const parcelMainRecord = (dataCache['Parcel_Main'] || []).find(p => (p.lrsn === lrsn || p.LRSN === lrsn));
            if (parcelMainRecord && (parcelMainRecord.tax_bill_id || parcelMainRecord.TAX_BILL_ID)) {
                zoomToParcelByTaxId(parcelMainRecord.tax_bill_id || parcelMainRecord.TAX_BILL_ID);
            }

            mainView.classList.add('hidden');
            detailView.classList.remove('hidden');
            
            const parcelData = masterData.find(p => p[LRSN_KEY] === lrsn);
            const spanId = parcelMainRecord ? (parcelMainRecord.tax_bill_id || parcelMainRecord.TAX_BILL_ID || 'N/A') : 'N/A';
            
            let html = `<div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-900">Property Details</h2>
                            <p class="text-lg text-[#003300]">${parcelData.FreeFormAddr || 'Address not available'}</p>
                            <p class="text-sm text-gray-500">LRSN: ${lrsn}</p>
                            <p class="text-sm text-gray-500">SPAN: ${spanId}</p>
                        </div>`;

            // --- NAVIGATION BUTTONS ---
            html += `<div id="detail-nav" class="my-4 p-4 bg-gray-100 rounded-lg shadow-inner sticky top-0 z-10">
                         <h4 class="text-sm font-semibold mb-2 text-gray-600">Quick Navigation</h4>
                         <div class="flex flex-wrap gap-2">`;
            for (const group in RELATED_FILES) {
                const sectionId = group.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                html += `<a href="#${sectionId}" class="nav-button bg-white hover:bg-gray-200 text-gray-700 text-sm font-medium py-2 px-3 rounded-lg border border-gray-300 shadow-sm transition-colors">${group}</a>`;
            }
            html += `</div></div>`;

            // --- DATA SECTIONS ---
            for (const group in RELATED_FILES) {
                const sectionId = group.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                html += `<section id="${sectionId}" class="related-section bg-white p-6 rounded-lg shadow-md mt-4 scroll-mt-24">
                            <h3 class="text-xl font-semibold text-gray-800">${group}</h3>`;
                
                let groupHasData = false;
                
                if (group === "Sketches & Images") {
                    const sketchVectors = (dataCache['Sketch_Vector'] || []).filter(record => (record.LRSN === lrsn || record.lrsn === lrsn));
                    if (sketchVectors.length > 0) {
                        groupHasData = true;
                        html += `<div class="my-4"><canvas id="sketch-canvas" width="500" height="400"></canvas></div>`;
                    }
                }

                RELATED_FILES[group].forEach(file => {
                    const relatedRecords = (dataCache[file] || []).filter(record => (record.LRSN === lrsn || record.lrsn === lrsn));
                    if (relatedRecords.length > 0) {
                        groupHasData = true;
                        html += `<h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">${file.replace(/_/g, ' ')}</h4>`;
                        
                        if (USE_CARD_VIEW.includes(file)) {
                            html += createDetailList(relatedRecords);
                        } else {
                            html += createHtmlTable(relatedRecords);
                        }
                    }
                });

                if (!groupHasData) {
                    html += `<p class="text-gray-500">No data available in this category.</p>`;
                }
                html += `</section>`;
            }

            detailContent.innerHTML = html;
            
            // Add smooth scrolling for nav buttons
            document.querySelectorAll('#detail-nav a').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if(targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            const canvas = document.getElementById('sketch-canvas');
            if (canvas) {
                drawSketch(lrsn, canvas);
            }

            leftPane.scrollTo(0, 0);
        }
        
        function showMainView() {
            detailView.classList.add('hidden');
            mainView.classList.remove('hidden');
            resetMapView(); // Return map to default extent
        }

        // --- UI RENDERING ---
        function renderMainTable() {
            statusMessage.classList.add('hidden');
            tableWrapper.classList.remove('hidden');
            renderMainTableHeaders();
            renderMainTablePage();
            renderPagination();
        }

        function renderMainTableHeaders() {
            const tableHead = dataTable.querySelector('thead');
            tableHead.innerHTML = '';
            if (masterData.length === 0) return;

            const headers = ['LRSN', 'Address', 'City', 'Zip'];
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
        }

        function renderMainTablePage() {
            const tableBody = dataTable.querySelector('tbody');
            tableBody.innerHTML = '';

            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">No properties found.</td></tr>`;
                updateTableInfo(0, 0);
                return;
            }

            const startIndex = (currentPage - 1) * ROWS_PER_PAGE;
            const endIndex = startIndex + ROWS_PER_PAGE;
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'main-table-row';
                tr.dataset.lrsn = row[LRSN_KEY];
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.LRSN || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.FreeFormAddr || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.StrtCity || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.StrtZip || ''}</td>
                `;
                tr.addEventListener('click', () => showDetailView(row[LRSN_KEY]));
                tableBody.appendChild(tr);
            });

            updateTableInfo(startIndex, endIndex);
        }

        function renderPagination() {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(filteredData.length / ROWS_PER_PAGE);
            if (totalPages <= 1) return;

            let html = `<div class="text-sm text-gray-700">Page <span class="font-medium">${currentPage}</span> of <span class="font-medium">${totalPages}</span></div>`;
            html += `<div class="flex items-center gap-2">
                        <button class="pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                        <button class="pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                     </div>`;
            paginationControls.innerHTML = html;

            document.querySelectorAll('.pagination-btn').forEach(button => {
                button.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed';
                button.addEventListener('click', (e) => {
                    currentPage = parseInt(e.target.dataset.page);
                    renderMainTablePage();
                    renderPagination();
                    dataTable.scrollIntoView({ behavior: 'smooth' });
                });
            });
        }

        // --- UTILITY FUNCTIONS ---
        function formatDateString(value) {
            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                return value.substring(0, 10);
            }
            return value;
        }
        
        function createDetailList(records) {
            if (!records || records.length === 0) return '';
            let listHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 text-sm">`;
            const record = records[0]; 
            for (const key in record) {
                const rawValue = record[key];
                const value = formatDateString(String(rawValue).trim());
                if (value && value !== '\u0000') {
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    listHtml += `
                        <div class="detail-card">
                            <strong class="block text-xs text-gray-500">${formattedKey}</strong>
                            <span class="text-gray-900">${value}</span>
                        </div>
                    `;
                }
            }
            listHtml += `</div>`;
            return listHtml;
        }

        function createHtmlTable(records) {
            if (!records || records.length === 0) return '<p class="text-sm text-gray-500">No records found.</p>';
            const headers = Object.keys(records[0]);
            let table = '<div class="overflow-x-auto table-container"><table class="min-w-full divide-y divide-gray-200">';
            table += '<thead class="bg-gray-50"><tr>';
            headers.forEach(h => table += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h.replace(/_/g, ' ')}</th>`);
            table += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            records.forEach(record => {
                table += '<tr>';
                headers.forEach(h => {
                    const formattedValue = formatDateString(record[h]);
                    table += `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formattedValue}</td>`
                });
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        function drawSketch(lrsn, canvas) {
            const vectors = (dataCache['Sketch_Vector'] || []).filter(v => (v.lrsn === lrsn || v.LRSN === lrsn));
            if (vectors.length === 0) return;

            const ctx = canvas.getContext('2d');
            const padding = 40;

            const segments = vectors.reduce((acc, v) => {
                const id = v.segment_id;
                if (!acc[id]) acc[id] = [];
                acc[id].push(v);
                return acc;
            }, {});

            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            let currentX = 0, currentY = 0;
            
            Object.values(segments).forEach(segmentVectors => {
                currentX = 0; currentY = 0;
                segmentVectors.forEach(v => {
                    const run = parseFloat(v.run) || 0;
                    const rise = parseFloat(v.rise) || 0;
                    minX = Math.min(minX, currentX); minY = Math.min(minY, currentY);
                    maxX = Math.max(maxX, currentX); maxY = Math.max(maxY, currentY);
                    currentX += run; currentY -= rise;
                    minX = Math.min(minX, currentX); minY = Math.min(minY, currentY);
                    maxX = Math.max(maxX, currentX); maxY = Math.max(maxY, currentY);
                });
            });

            const sketchWidth = maxX - minX;
            const sketchHeight = maxY - minY;
            if (sketchWidth === 0 || sketchHeight === 0) return;

            const canvasWidth = canvas.width - padding * 2;
            const canvasHeight = canvas.height - padding * 2;
            const scale = Math.min(canvasWidth / sketchWidth, canvasHeight / sketchHeight);
            const offsetX = (canvas.width - sketchWidth * scale) / 2 - minX * scale;
            const offsetY = (canvas.height - sketchHeight * scale) / 2 - minY * scale;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 2;
            ctx.font = '10px Inter';
            ctx.fillStyle = '#4b5563';

            Object.values(segments).forEach(segmentVectors => {
                currentX = 0; currentY = 0;
                ctx.beginPath();
                ctx.moveTo(offsetX, offsetY);

                segmentVectors.forEach(v => {
                    const run = parseFloat(v.run) || 0;
                    const rise = parseFloat(v.rise) || 0;
                    const length = parseFloat(v.vector_length) || 0;

                    const startDrawX = currentX * scale + offsetX;
                    const startDrawY = currentY * scale + offsetY;
                    
                    currentX += run;
                    currentY -= rise;
                    
                    const endDrawX = currentX * scale + offsetX;
                    const endDrawY = currentY * scale + offsetY;

                    ctx.lineTo(endDrawX, endDrawY);

                    if (length > 0) {
                        const midX = (startDrawX + endDrawX) / 2;
                        const midY = (startDrawY + endDrawY) / 2;
                        const angle = Math.atan2(endDrawY - startDrawY, endDrawX - startDrawX);
                        const labelOffsetX = Math.sin(angle) * 10;
                        const labelOffsetY = -Math.cos(angle) * 10;

                        ctx.save();
                        ctx.translate(midX + labelOffsetX, midY + labelOffsetY);
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(length.toFixed(1), 0, 0);
                        ctx.restore();
                    }
                });
                ctx.stroke();
            });
        }

        function showLoading(message) {
            statusMessage.innerHTML = `<div class="flex flex-col items-center gap-4"><div class="loader h-12 w-12 rounded-full border-4 border-gray-200"></div><p class="text-gray-500 text-lg">${message}</p></div>`;
            statusMessage.classList.remove('hidden');
            tableWrapper.classList.add('hidden');
        }

        function showError(message) {
            statusMessage.innerHTML = `<p class="text-red-600 bg-red-100 p-4 rounded-md">${message}</p>`;
        }
        
        function updateTableInfo(startIndex, endIndex) {
            const end = Math.min(endIndex, filteredData.length);
            const start = filteredData.length > 0 ? startIndex + 1 : 0;
            tableInfo.textContent = `Showing ${start} to ${end} of ${filteredData.length} properties.`;
        }

        // --- START THE APP ---
        initialize();
    });
    </script>

</body>
</html>
